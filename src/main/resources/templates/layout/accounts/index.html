<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity6">
<!-- Head & css links -->
<head th:replace="~{fragments/headFragment::head-section}">
</head>
<body>
<div id="app">
    <div class="main-wrapper main-wrapper-1">
        <div class="navbar-bg"></div>
        <!-- Navbar -->
        <nav th:replace="~{fragments/navbarFragment::nav-section}"></nav>
        <!-- Sidebar -->
        <div th:replace="~{fragments/sidebarFragment::sidebar-section}"></div>
        <!-- Main Content -->
        <div class="main-content">
            <section class="section">
                <div class="section-header">

                    <div class="fa-align-left">
                        <label for="from" th:text="#{frm.start.date}"> </label> <br>
                        <input id="from" type="date" class="date-input">
                    </div>
                    <div class="fa-align-right">
                        <label for="to" th:text="#{frm.end.date}"> </label> <br>
                        <input id="to" type="date" class="date-input">
                    </div>
                    <button id="applyDates" class="btn btn-primary float-right"
                         onclick="filterByDates()"   th:text="#{blt.dates.apply}"></button>
                    <button id="resetDatesBtn" class="btn btn-outline-dark float-right"
                            th:text="#{blt.dates.reset}"></button>
                    <div class="card align-content-end float-right ">
                        <div class="dropdown d-inline mr-2">
                            <button class="btn btn-primary dropdown-toggle" type="button"
                                    data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                Sort by
                            </button>
                            <div class="dropdown-menu" aria-labelledby="sortByButton">
                                <a class="dropdown-item" href="#" data-sort="number">Account number</a>
                                <a class="dropdown-item" href="#" data-sort="type">Account type</a>
                                <a class="dropdown-item" href="#" data-sort="createdDate">Created Date</a>
                                <a class="dropdown-item" href="#" data-sort="balance">Account balance</a>
                            </div>
                        </div>
                    </div>
                    <div>
                        <div class="dropdown d-inline mr-2">
                            <button class="btn btn-primary dropdown-toggle" type="button"
                                    data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                Sorting order
                            </button>
                            <div class="dropdown-menu" aria-labelledby="sortOrderButton">
                                <a class="dropdown-item" href="#" data-order="asc">Ascending order</a>
                                <a class="dropdown-item" href="#" data-order="desc">Descending order</a>
                            </div>
                        </div>
                        <button id="applySortBtn" class="btn btn-primary">Apply Sorting</button>
                    </div>
                </div>


                <div class="section-body">
                    <div class="row">
                        <div class="col-12">
                            <div class="card">
                                <div id="getResultDiv"></div>
                                <div class="card-header">
                                    <h4 th:text="#{acconts.tbls.title}"></h4>
                                </div>
                                <div class="card-body">
                                    <table class="table">
                                        <thead>
                                        <tr>
                                            <th scope="col" th:text="#{accounts.tbls.createAt}"></th>
                                            <th scope="col" th:text="#{accounts.tbls.currency}"></th>
                                            <th scope="col" th:text="#{accounts.tbls.number}"></th>
                                            <th scope="col" th:text="#{accounts.tbls.balance}"></th>
                                            <th scope="col" th:text="#{accounts.tbls.type}"></th>
                                            <th scope="col"></th>
                                        </tr>
                                        </thead>
                                        <tbody id="accountsTableBody">


                                        </tbody>
                                    </table>

                                    <div class="card">
                                        <div class="card-header">
                                        </div>
                                        <div class="card-body">
                                            <nav aria-label="Page navigation example">
                                                <ul class="pagination">
                                                    <li class="page-item"><a class="page-link"
                                                                             id="prevPage">Previous</a>
                                                    </li>
                                                    <li class="page-item"><a id="currentPage" class="page-link"
                                                                             href="#"></a>
                                                    </li>
                                                    <li class="page-item"><a class="page-link" id="nextPage">Next</a>
                                                    </li>
                                                    <li class="page-item"><a id="totalPages" class="page-link" href="#">Next</a>
                                                    </li>
                                                    <li class="page-item">
                                                        <p>Total Elements: </p>
                                                        <a class="page-link" disabled="true" id="totalElements">
                                                        </a>
                                                    </li>

                                                </ul>

                                            </nav>
                                        </div>
                                    </div>
                                </div>

                            </div>

                        </div>
                    </div>
                </div>
            </section>
        </div>
        <!-- Footer -->
        <footer th:replace="~{fragments/footerFragment::footer-section}"></footer>
        <!-- Js-links -->
        <div th:replace="~{fragments/footFragment::js-links}"></div>
    </div>
</div>
</body>
<script>
    let totalPages = 0;
    const apiUrl = '/api/accounts'; // Replace with your actual API URL
    // default values
    let params = {
        page: 1,
        searchQuery: '',
        sortBy: '',
        order: '',
        from: '',
        to: ''
    };
    // Utility function to populate table rows
    // Populate table rows
    function populateTableRows(data) {
        const tableBody = document.getElementById('accountsTableBody');
        tableBody.innerHTML = ''; // Clear existing rows

        if (!Array.isArray(data) || data.length === 0) {
            const noDataRow = document.createElement('tr');
            noDataRow.innerHTML = `
            <td colspan="6" class="text-center">No accounts to display</td>
        `;
            tableBody.appendChild(noDataRow);
            return;
        }

        data.forEach(account => {
            const row = document.createElement('tr');
            row.innerHTML = `
            <td>${account.createdDate || ''}</td>
            <td>${account.currency || ''}</td>
            <td>${account.number || ''}</td>
            <td>${account.balance || ''}</td>
            <td>${account.type || ''}</td>
            <td><button class="btn btn-danger deleteBtn" data-id="${account.slug}">Delete</button></td>
        `;
            tableBody.appendChild(row);
        });

        // Add event listeners to delete buttons
        document.querySelectorAll('.deleteBtn').forEach(button => {
            button.addEventListener('click', handleDelete);
        });
    }

    // Filtering by start and end dates
    async function filterByDates () {
        const from = document.getElementById('from').value;
        const to = document.getElementById('to').value;

        params = {
            page: document.getElementById('currentPage').value || 1,
            searchQuery: '',
            sortBy: '',
            order: '',
            from: from,
            to: to
        }

        await loadTableData(params)
    }

    // Load table data
    async function loadTableData(params = {}) {
        try {
            const data = await fetchAPI.get(apiUrl, params);
            console.log("Received data", data);

            // Adjust for your API structure

            console.log("Received data data.items ", data)
            totalPages = data.totalPages;
            console.log("Total pages of this request: ", totalPages)
            populateTableRows(data.accounts);

            // Update pagination
            document.getElementById('currentPage').textContent = data.currentPage || 1;
            document.getElementById('totalPages').textContent = data.totalPages || 1;
            document.getElementById('totalElements').textContent = data.totalElements || 0;
            document.getElementById('prevPage').classList.toggle('disabled', !data.hasPrevPage);
            document.getElementById('nextPage').classList.toggle('disabled', !data.hasNextPage);
        } catch (error) {
            console.error('Error loading data:', error);
        }
    }

    // Sort accounts
        // Getting values of sortBy & order
        let selectedSortField = '';
        let selectedSortOrder = '';
        document.addEventListener("DOMContentLoaded", () => {

            const updateDropdownButtonText = (button, text) => {
                button.innerText = `${text} (Selected)`;
            };

            // Handle sorting field selection
            const sortByButton = document.querySelector('button[aria-labelledby="sortByButton"]');
            document.querySelectorAll('.dropdown-menu a[data-sort]').forEach(item => {
                item.addEventListener('click', (event) => {
                    event.preventDefault();
                    selectedSortField = event.target.getAttribute('data-sort');
                    updateDropdownButtonText(sortByButton, event.target.innerText);
                });
            });

            // Handle sorting order selection
            const sortOrderButton = document.querySelector('button[aria-labelledby="sortOrderButton"]');
            document.querySelectorAll('.dropdown-menu a[data-order]').forEach(item => {
                item.addEventListener('click', (event) => {
                    event.preventDefault();
                    selectedSortOrder = event.target.getAttribute('data-order');
                    updateDropdownButtonText(sortOrderButton, event.target.innerText);
                });
            });

            // Handle Apply Sorting button click
            const applySortBtn = document.getElementById("applySortBtn");
            applySortBtn.addEventListener('click', () => {
                if (!selectedSortField || !selectedSortOrder) {
                    alert("Please select both a sorting field and sorting order before applying.");
                    return;
                }

                // Populate the fields used in `handleFilter`
                const sortByField = document.getElementById("sortBy");
                const sortOrderField = document.getElementById("sortOrder");

                if (sortByField && sortOrderField) {
                    sortByField.value = selectedSortField;
                    sortOrderField.value = selectedSortOrder;
                }
                console.log("SelectedByField's value: ",selectedSortField
                , " SelectedOrder's value: ", selectedSortOrder)
                // Preparing params to send the request
                params = {
                    page: document.getElementById('currentPage').textContent || 1,
                    searchQuery: '' || document.getElementById('searchQuery').value,
                    sortBy: selectedSortField,
                    order: selectedSortOrder,
                    from: document.getElementById('from').value || '',
                    to: document.getElementById('to').value || ''
                }
                // sending the request
                loadTableData(params);
                console.log("Sorting applied:", { sortBy: selectedSortField, order: selectedSortOrder });
            });
        });




    // Handle search and filtering
    async function handleFilter() {

        let fromDate = document.getElementById('from').value || '';
        let toDate = document.getElementById('to').value || '';
        let searchQuery = document.getElementById('searchQuery').value.trim() || '';
        console.log("From date "+fromDate+" to date "+toDate+" search "+searchQuery);
        params.page = document.getElementById('currentPage').textContent || 1;
        params.sortBy = selectedSortField;
        params.order = selectedSortOrder;
        params.searchQuery = searchQuery;
        params.from = fromDate;
        params.toDate = toDate;

        await loadTableData(params);
    }

    // Handle pagination
    async function handlePagination(event) {
        const targetId = event.target.id;
        let currentPage = parseInt(document.getElementById('currentPage').textContent, 10);
        const prevPageBtn = document.getElementById('prevPage');
        const nextPageBtn = document.getElementById('nextPage');

        if (targetId === 'prevPage' && currentPage > 1) {
            currentPage -= 1;
        } else if (targetId === 'nextPage' && currentPage < totalPages) {
            currentPage += 1;
        }

        prevPageBtn.disabled = currentPage === 1;
        nextPageBtn.disabled = currentPage === totalPages;

        params = {
            page: currentPage,
            searchQuery: '',
            sortBy: '',
            order: '',
            from: '',
            to: ''
        }
        await loadTableData(params);
    }

    // Handle delete request
    async function handleDelete(event) {
        const slug = event.target.dataset.id;
        console.log("Account slug: ",slug)

        if (confirm('Are you sure you want to delete this account?')) {
            try {
                const res = await fetchAPI.delete(apiUrl, { slug: slug });
                console.log("Delete response: ",res);
                // Reloading table's data
                await loadTableData(
                    params = {
                        page: document.getElementById('currentPage').textContent || 1,
                        searchQuery: '',
                        sortBy: '',
                        order: '',
                        from: '',
                        to: ''
                    }
                );
            } catch (error) {
                console.error('Error deleting account:', error);
            }
        }
    }

    // Event listeners
    document.getElementById('filterBtn').addEventListener('click', handleFilter);
    document.getElementById('applyDates').addEventListener('click', handleFilter);
    document.getElementById('resetDatesBtn').addEventListener('click', () => loadTableData()); // Reset dates and reload
    document.getElementById('prevPage').addEventListener('click', handlePagination);
    document.getElementById('nextPage').addEventListener('click', handlePagination);

    // Initial load
    window.addEventListener('DOMContentLoaded', () => {
        loadTableData(params); // Load table data on page load
    });
</script>

<script>
    document.getElementById('resetDatesBtn').addEventListener('click', function () {
        // Select all input elements of type 'date'
        const dateInputs = document.querySelectorAll('input[type="date"]');

        // Loop through each input and set its value to an empty string
        dateInputs.forEach(input => {
            input.value = '';
        });
    });
</script>
</html>